<div class="modal-overlay" *ngIf="isOpen && cliente && cartoes.length > 0" (click)="onOverlayClick($event)">
  <div class="modal-container">
    <div class="modal-header">
      <h2 class="modal-title">Solicitação de Segunda Via</h2>
      <button class="modal-close" (click)="fecharModal()" aria-label="Fechar">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <!-- Informações do Cliente -->
      <div class="detail-section">
        <div class="detail-header">
          <svg class="detail-icon" width="48" height="48" viewBox="0 0 48 48" fill="none">
            <circle cx="24" cy="24" r="22" fill="#E0F2FE" stroke="#3B82F6" stroke-width="2"/>
            <circle cx="24" cy="18" r="6" stroke="#3B82F6" stroke-width="2" fill="none"/>
            <path d="M12 38C12 32 16 28 24 28C32 28 36 32 36 38" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <div class="detail-header-info">
            <h3 class="detail-name">{{ cliente.nome }}</h3>
            <p class="detail-subtitle">ID: #{{ cliente.id }}</p>
          </div>
        </div>
      </div>

      <!-- Seleção de Cartões -->
      <div class="section-title">Selecione um Cartão</div>
      <div class="cartoes-grid">
        <div
          *ngFor="let cartao of cartoes"
          class="cartao-card"
          [class.cartao-selecionado]="cartaoSelecionado?.numero === cartao.numero"
          (click)="selecionarCartao(cartao)"
        >
          <div class="cartao-header">
            <span class="cartao-numero">{{ formatarNumeroCartao(cartao.numero) }}</span>
            <span
              class="cartao-status"
              [style.backgroundColor]="obterCorStatus(cartao.status)"
            >
              {{ cartao.status }}
            </span>
          </div>

          <div class="cartao-body">
            <div class="cartao-info">
              <span class="cartao-label">Vencimento</span>
              <span class="cartao-valor">{{ cartao.dataVencimento }}</span>
            </div>
            <div class="cartao-info">
              <span class="cartao-label">Tipo</span>
              <span class="cartao-valor">{{ cartao.tipoCartao }}</span>
            </div>
          </div>

          <div class="cartao-footer">
            <span class="cartao-limite">Limite: R$ {{ cartao.limite | number: '1.2-2' }}</span>
          </div>

          <!-- Checkmark de seleção -->
          <div class="cartao-checkmark" *ngIf="cartaoSelecionado?.numero === cartao.numero">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="white"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- Mensagem de erro - Seleção de cartão -->
      <div class="error-message" *ngIf="mensagemErro && !cartaoSelecionado">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M8 4V9M8 12V13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        {{ mensagemErro }}
      </div>

      <!-- Dados do Cartão Selecionado -->
      <div *ngIf="cartaoSelecionado" class="section-title">Dados do Cartão Selecionado</div>
      <div class="detail-grid" *ngIf="cartaoSelecionado">
        <div class="detail-item">
          <label class="detail-label">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <rect x="2" y="4" width="12" height="8" rx="1.5" stroke="#6B7280" stroke-width="1.5" fill="none"/>
              <path d="M2 7H14" stroke="#6B7280" stroke-width="1.5"/>
            </svg>
            Número do Cartão
          </label>
          <p class="detail-value">{{ formatarNumeroCartao(cartaoSelecionado.numero) }}</p>
        </div>

        <div class="detail-item">
          <label class="detail-label">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <circle cx="8" cy="8" r="6" stroke="#6B7280" stroke-width="1.5" fill="none"/>
              <path d="M8 4V8L11 11" stroke="#6B7280" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            Data de Vencimento
          </label>
          <p class="detail-value">{{ cartaoSelecionado.dataVencimento }}</p>
        </div>

        <div class="detail-item">
          <label class="detail-label">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <rect x="3" y="3" width="10" height="10" rx="1" stroke="#6B7280" stroke-width="1.5" fill="none"/>
              <path d="M6 6H10M6 9H8" stroke="#6B7280" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            Tipo de Cartão
          </label>
          <p class="detail-value">{{ cartaoSelecionado.tipoCartao }}</p>
        </div>
      </div>

      <!-- Aviso Importante -->
      <div class="detail-info-box info-warning">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M10 2L2 18H18L10 2Z" stroke="#F59E0B" stroke-width="2" fill="none"/>
          <path d="M10 8V12M10 14V15" stroke="#F59E0B" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <p class="detail-info-text">
          <strong>Atenção:</strong> A solicitação de segunda via resultará no cancelamento do cartão atual e emissão de um novo cartão com número diferente.
        </p>
      </div>

      <!-- Campo de Motivo -->
      <div class="section-title">Motivo da Solicitação</div>
      <div class="form-group">
        <label class="form-label" for="motivo">
          Descreva o motivo da solicitação de segunda via *
        </label>
        <textarea
          id="motivo"
          class="form-textarea"
          [(ngModel)]="motivo"
          placeholder="Ex: Cartão perdido, cartão danificado, cartão roubado..."
          rows="4"
          [disabled]="isSubmitting"
          maxlength="500"
        ></textarea>
        <div class="form-hint">
          {{ motivo.length }}/500 caracteres
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button
        class="btn-secondary"
        (click)="fecharModal()"
        [disabled]="isSubmitting"
      >
        Cancelar
      </button>
      <button
        class="btn-primary"
        (click)="confirmarSolicitacao()"
        [disabled]="isSubmitting || !cartaoSelecionado || !motivo.trim()"
      >
        <span *ngIf="!isSubmitting">Confirmar Solicitação</span>
        <span *ngIf="isSubmitting" class="btn-loading">
          <svg class="spinner" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="2" stroke-opacity="0.3" fill="none"/>
            <path d="M14 8C14 4.7 11.3 2 8 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Processando...
        </span>
      </button>
    </div>
  </div>
</div>
